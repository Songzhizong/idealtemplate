# 前端权限控制设计规范

本文档详述了系统前端权限控制的设计方案与实现模式，涵盖**路由级**、**菜单级**及**细粒度组件级**（按钮、表格列、输入框等）的控制策略。

## 1. 核心架构

系统采用 RBAC (Role-Based Access Control) 模型，由 `authStore` (Zustand) 统一管理认证与权限逻辑。

- **类型安全**: 使用 `Permission` 联合类型确保权限标识符在 IDE 中的自动补全。
- **权限校验**: 核心方法为 `hasPermission(permission: Permission | Permission[], mode?: 'AND' | 'OR')`。
- **上帝模式**: 系统内置对超级管理员 (`admin`) 的逻辑豁免。

为了防止权限标识符拼写错误并提升开发体验，我们在 `src/config/permissions/` 目录中维护权限常量，并根据功能模块进行拆分（如 `users.ts`）。最后在 `src/types/auth.ts` 中统一导出：

```typescript
// src/config/permissions/users.ts
export const USER_PERMISSIONS = {
  USERS_READ: "users:read",
  // ...
} as const;

// src/types/auth.ts
export { PERMISSIONS } from "@/config/permissions";
export type Permission = (typeof PERMISSIONS)[keyof typeof PERMISSIONS] | (string & {});
```

### 3. 异步路由守卫 (Async Route Guard)

使用 TanStack Router 的 `beforeLoad` 钩子。通过 `async/await` 确保在鉴权前用户信息（权限列表）已完成初始化。

```typescript
// src/routes/_authenticated.users.tsx
export const Route = createFileRoute("/_authenticated/users")({
  beforeLoad: async () => {
    // 1. 确保 Store 已初始化 (防止刷新页面时状态丢失)
    if (!authStore.getState().isInitialized) {
      await authStore.getState().initialize();
    }

    const { hasPermission } = authStore.getState();

    // 2. 校验权限
    if (!hasPermission("users:read")) {
      throw redirect({ to: "/errors/403" });
    }
  },
})
```


## 4. 菜单级控制 (Sidebar Filtering)

在 `nav-config.ts` 中配置 `permission` 字段，布局组件会自动过滤。

```typescript
{ title: "用户管理", to: "/users", permission: "users:read" }
```

## 5. 组件级细粒度控制 (DX 优化)

### 5.1 &lt;PermissionGate /&gt; (声明式包裹)
用于控制任意 UI 块的显隐。

```tsx
<PermissionGate
  permission={['users:add', 'users:edit']}
  mode="OR"
  fallback={<p>无权操作</p>}
>
  <YourComponent />
</PermissionGate>
```

### 5.2 &lt;AuthButton /&gt; (复合按钮)
集成自动禁用逻辑与 Tooltip 提示。

> [!TIP]
> **交互细节**: 当 `Button` 处于 `disabled` 状态时不会触发原生鼠标事件。因此，在实现中我们使用 `<span>` 包裹按钮，以确保 Tooltip 在禁用状态下仍能正常显示。

```tsx
<AuthButton permission="users:add" tooltipContent="您没有新增用户的权限">
  新增用户
</AuthButton>
```

### 5.3 表格列控制
通过 `useMemo` 结合权限动态生成 `columns` 定义。

```tsx
const columns = useMemo(() => {
  const base = [...];
  if (hasPermission("users:view_phone")) {
    base.push({ accessorKey: "phone", header: "手机号" });
  }
  return base;
}, [hasPermission]);
```

## 6. 高级逻辑说明

- **组合权限**: `hasPermission(['A', 'B'], 'AND')` 要求同时拥有 A 和 B；`'OR'` 模式满足其一即可。
- **初始化延迟**: 受保护路由的渲染会等待用户信息初始化完成，避免因数据未就绪导致的错误重定向。
- **后端同步**: 前端权限码应与后端 Swagger/API 定义保持严格一致。

## 7. 总结

1. **路由守卫**解决“能不能进”的问题。
2. **菜单过滤**解决“看不看得见”的问题。
3. **组件/按钮控制**解决“能不能点”的问题。
4. **后端鉴权**解决“最终安全性”的问题。
